"use strict";var LPFile=function(t){this.name="",this.size="",this.file="",this.data="",this.value="",this.url="",this.onthumbprogress=$.noop,this.onprogress=$.noop,this.onupdateurl=$.noop,this.uploadurl="/",this.onthumbloaded=$.noop,this.response_type="string",this.thumbnail="",this.uploaded=!1,this.is_pdf=!1,this.is_doc=!1,this.is_csv=!1,this.is_xls=!1,this.is_xlsx=!1,void 0!==t&&(this.file=void 0!==t.file?t.file:"","object"==typeof this.file&&(this.name=void 0!==this.file.name?this.file.name:"",this.size=void 0!==this.file.size?this.file.size:""),this.onthumbprogress=void 0===t.onthumbprogress?$.noop:t.onthumbprogress,this.onprogress=void 0===t.onprogress?$.noop:t.onprogress,this.onupdateurl=void 0===t.onupdateurl?$.noop:t.onupdateurl,this.uploadurl=void 0===t.uploadurl?"/":t.uploadurl,this.onthumbloaded=void 0===t.onthumbloaded?$.noop:t.onthumbloaded,this.response_type=void 0===t.response_type?"string":t.response_type,this.thumbnail=void 0===t.thumbnail?"thumbnail":t.thumbnail,this.uploaded=void 0!==t.uploaded&&t.uploaded,this.is_pdf=LPFile.isPDF(this.name),this.is_doc=LPFile.isDOC(this.name),this.is_csv=LPFile.isCSV(this.name),this.is_xls=LPFile.isXLS(this.name),this.is_xlsx=LPFile.isXLSX(this.name)),this.thumbPercent=0,this.percentComplete=0,""!==this.thumbnail&&(this.response_type="json")};LPFile.prototype.loadThumb=function(t){var e=this,i=new FileReader,o=this.file;i.onload=function(i){e.data=i.target.result,e.onthumbloaded(e.data),setTimeout(function(){t()},100)},i.onprogress=function(t){if(t.lengthComputable)return e.thumbPercent=parseInt(t.loaded/t.total*100),void e.onthumbprogress(e.thumbPercent);e.thumbPercent=100},i.readAsDataURL(o)},LPFile.prototype.generateBlob=function(t,e,i){e=e||"",i=i||512;for(var o=t,s=[],a=0;a<o.length;a+=i){for(var n=o.slice(a,a+i),l=new Array(n.length),r=0;r<n.length;r++)l[r]=n.charCodeAt(r);var p=new Uint8Array(l);s.push(p)}return new Blob(s,{type:e})},LPFile.prototype.upload=function(t){var e=this,i=new FormData;i.append("name",this.name),i.append("size",this.size),i.append("data",this.generateBlob(this.data,"text/plain",512)),$.ajax({contentType:!1,processData:!1,cache:!1,url:e.uploadurl,type:"POST",xhr:function(){var t=$.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",function(t){var i=t.loaded||t.position;e.percentComplete=Math.ceil(i/t.total*100),e.onprogress(e.percentComplete)},!1),t},beforeSend:function(t,e){e.data=i}}).done(function(i){e.value=i,e.onupdateurl(e.getThumbnailURI(i)),t()})},LPFile.prototype.getThumbnailURI=function(t){return"string"===this.response_type?(this.url=t,t):("object"!=typeof t?t=$.parseJSON(t):this.value=JSON.stringify(t),this.url=t[this.thumbnail],t[this.thumbnail])},LPFile.prototype.getPDFThumbnail=function(){return"https://84static.loadingplay.com/static/images/200_63e0df68422fbcd4404f9b6efebdb3fc_1454400396_pdfs.png"},LPFile.prototype.getDOCThumbnail=function(){return"https://84static.loadingplay.com/static/images/200_ffeb16b005f724fa55b75549ffd0306f_docicon.png"},LPFile.prototype.getCSVThumbnail=function(){return"https://7static.loadingplay.com/static/images/200_f9d12d737ae30a1551fc17479207e838_export_csv.png"},LPFile.prototype.getXLSThumbnail=function(){return"https://7static.loadingplay.com/static/images/200_16bd5b8b38ce1e5c3fd550908d9a75dc_xlsx.png"},LPFile.prototype.getXLSXThumbnail=function(){return"https://7static.loadingplay.com/static/images/200_16bd5b8b38ce1e5c3fd550908d9a75dc_xlsx.png"},LPFile.isImage=function(t){return-1!==t.toLowerCase().indexOf(".jpg")||-1!==t.toLowerCase().indexOf(".png")},LPFile.isPDF=function(t){return-1!==t.toLowerCase().indexOf(".pdf")},LPFile.isDOC=function(t){return-1!==t.toLowerCase().indexOf(".doc")},LPFile.isCSV=function(t){return-1!==t.toLowerCase().indexOf(".csv")},LPFile.isXLS=function(t){return-1!==t.toLowerCase().indexOf(".xls")},LPFile.isXLSX=function(t){return-1!==t.toLowerCase().indexOf(".xlsx")},LPFile.isAcceptedFile=function(t){return LPFile.isImage(t)||LPFile.isPDF(t)||LPFile.isDOC(t)||LPFile.isCSV(t)||LPFile.isXLS(t)||LPFile.isXLSX(t)};var FileUploader=function(t,e){this.$obj=$(t),this.options=e,this.waterfall=new Waterfall,this.waterfall.onready=function(){setTimeout(function(){e.onready()},500)},this.model=[],this.view=new FileUploaderView(this),this.view.init(),this.preloadImages(e.images)};FileUploader.prototype.applySort=function(t){var e=[];for(var i in t)e.push(this.model[t[i]]);this.model=e},FileUploader.prototype.addImagePreloading=function(t,e){var i=this,o=null,s=new Blob;if(s.name=e.name,void 0!==(o=i.addImage(s,!0))){if(o.value=e.value,o.url=e.src,o.percentComplete=100,o.is_pdf)i.view.showThumb(t,o.getPDFThumbnail());else if(o.is_doc)i.view.showThumb(t,o.getDOCThumbnail());else if(o.is_csv)i.view.showThumb(t,o.getCSVThumbnail());else if(o.is_xls)i.view.showThumb(t,o.getXLSThumbnai());else if(o.is_xlsx)i.view.showThumb(t,o.getXLSXThumbnail());else if("local"==i.options.thumbnail_origin)i.view.showThumb(t,o.value);else{var a=o.value;""!==i.options.thumbnail&&("object"!=typeof o.value&&(o.value=$.parseJSON(o.value)),a=o.value[i.options.thumbnail]),i.view.showThumb(t,a)}i.view.updateurl()}},FileUploader.prototype.preloadImages=function(t){for(var e=0;e<t.length;e++){var i=t[e];this.addImagePreloading(e,i)}this.options.onready()},FileUploader.prototype.isValidFile=function(t){var e=t.split("."),i=e[e.length-1].toLowerCase();return-1!==this.options.files_supported.indexOf(i)},FileUploader.prototype.addImage=function(t,e){var i=this;if(this.isValidFile(t.name)&&LPFile.isAcceptedFile(t.name)){var o=new LPFile({uploaded:e,file:t,uploadurl:this.options.uploadurl,response_type:this.options.response_type,thumbnail:this.options.thumbnail,onprogress:function(t){i.view.updateUploadProgress(i.model.indexOf(o),t)},onthumbprogress:function(t){i.view.updateThumbProgress(i.model.indexOf(o),t)},onthumbloaded:function(){i.view.imageDataLoaded(i.model.indexOf(o))},onupdateurl:function(t){i.view.updateurl(i.model.indexOf(o),t),o.is_pdf?i.view.showThumb(i.model.indexOf(o),o.getPDFThumbnail()):o.is_doc?i.view.showThumb(i.model.indexOf(o),o.getDOCThumbnail()):o.is_csv?i.view.showThumb(i.model.indexOf(o),o.getCSVThumbnail()):o.is_xls?i.view.showThumb(i.model.indexOf(o),o.getXLSThumbnail()):o.is_xlsx?i.view.showThumb(i.model.indexOf(o),o.getXLSXThumbnail()):"local"===i.options.thumbnail_origin?i.view.showThumb(i.model.indexOf(o),o.data):i.view.showThumb(i.model.indexOf(o),t)}});return this.options.multi||(this.model=[],this.waterfall.clearImages()),this.model.push(o),this.waterfall.appendImage(o),this.view.addImage(o),o}},FileUploader.prototype.getImageList=function(){return this.model},FileUploader.prototype.getInput=function(){return this.$obj},FileUploader.prototype.isready=function(){for(var t=0;t<this.model.length;t++){if(!(100==this.model[t].percentComplete))return!1}return!0},FileUploader.prototype.getBaseURL=function(){return this.options.base_url},FileUploader.prototype.getImagesData=function(){for(var t=[],e=0;e<this.model.length;e++){var i=this.model[e];""!==i.value&&("string"!=typeof i.value&&(i.value=JSON.stringify(i.value)),t.push(i.value))}return t},FileUploader.prototype.deleteImage=function(t){this.model.splice(t,1)};var FileUploaderTemplates={"imgup-template":'         <div class="imgup" name="THEY HATIIN" >             <ul class="img-ulist" name="THEY SEE ME ROOOLLIN">             </ul>         </div>',"imgup-image-template":'         <li>             <div class="img-container" >                 <img src="" class="imgup-image" pos-x="50" pos-y="50"/>                 <div>                    <a class="imgup-delete-button" href="#!" >x</a>                </div>                <div class="imgup-progress" >                     <div class="imgup-progress-bar" ></div>                 </div>             </div>         </li>',"imgup-image-add-template":'         <li class="imgup-add-input-container" >             <input type="file" class="imgup-add-input" multiple="multiple" />         </li>',"imgup-highlight-template":'        <div class="img-container" >             <img src="{{ src }}" class="imgup-image-biger"/>         </div>    '},FileUploaderView=function(t){var e=this;this.controller=t,this.main_template="",this.img_template="",this.add_img_template="",this.highlight_template="",this.$images=[],this.$main_template=void 0,this.loadTemplates(),this.thumbs_loading=[],this.is_loading=!1,this.fading=!1,this.$container=$('<div class="imageuploader-container" ></div>'),this.controller.options.sortable&&this.initSortable(function(t){e.controller.applySort(t),e.updateurl(),e.controller.options.onready()})};FileUploaderView.prototype.initSortable=function(t){var e=this,i="li:not(.imgup-add-input-container)";this.includeJqueryUI(function(){$("ul.img-ulist",e.$container).sortable({items:i,sort:function(){var t=0;$(i,$(this)).each(function(){$(this).hasClass("ui-sortable-placeholder")||($(this).attr("index",t),t++)})},update:function(e){var o=[];$(i,$(this)).each(function(){var t=parseInt($(this).attr("index"));o.push(t)}),t(o)}})})},FileUploaderView.prototype.includeJqueryUI=function(t){void 0==jQuery.ui?jQuery.getScript("https://code.jquery.com/ui/1.11.4/jquery-ui.js",function(){t()}):setTimeout(function(){t()},1e3)},FileUploaderView.prototype.init=function(){var t=this.controller.getInput();t.css("visibility","hidden");try{t.attr("type","text")}catch(e){t.each(function(){this.type="text"})}t.after(this.$container),this.render()},FileUploaderView.prototype.addInputEvent=function(t){var e=this;t.change(function(t){var i=0,o=t.target.files;for(i=0;i<o.length;i++)e.controller.addImage(o[i])})},FileUploaderView.prototype.addImage=function(t){this.clearImages();var e=this,i=$(this.img_template),o=$(".imgup-delete-button",i),s=$(".imgup-add-input-container",this.$main_template);$.data(o,"lpparent",i),$.data(i,"lpimage",t),this.applyPercent(i,t.thumbPercent),$(i).insertBefore(s),this.controller.options.multi||s.addClass(this.controller.options.hidden_class),this.controller.options.highlight_spot&&i.on("click",function(t){if(!e.fading&&e.controller.isready()){e.fading=!0;var i=$(this).closest("div.imgup"),o=$(this).closest("ul.img-ulist"),s=$(this).find("img.imgup-image"),a=s.attr("src");o.fadeOut("slow",function(){var t='<div class="img-container" id="img-container-big"> <img id="big-img" src="'+a+'" class="imgup-image-biger"/> <i id="dot-aim" class="fa fa-cloud tiny" style="color: red; position: absolute;"></i> </div> <button class="done">DONE</button>';i.append(t);var n=$("i#dot-aim"),l=$("img#big-img").position(),r=$("img#big-img").height(),p=$("img#big-img").width(),u=s.attr("pos-x"),d=s.attr("pos-y"),h=!1,m=i.find("button.done");n.css({left:+(l.left-n.width()/2+p*u*.01)+"px",top:+(l.top-n.height()/2+r*d*.01)+"px"}),$("#big-img").on("dragstart",function(t){t.preventDefault()}),$(document).on("mousemove",function(t){h&&(t.pageX>l.left&&t.pageX<l.left+p&&(u=100*(t.pageX-l.left)/p),t.pageY>l.top&&t.pageY<l.top+r&&(d=100*(t.pageY-l.top)/r),n.css({left:+(l.left-n.width()/2+p*u*.01)+"px",top:+(l.top-n.height()/2+r*d*.01)+"px"}))}),$(document).on("mousedown",function(t){1==t.which&&t.pageY>l.top&&t.pageY<l.top+r&&t.pageX>l.left&&t.pageX<l.left+p&&(h=!0)}),$(document).on("mouseup",function(t){1==t.which&&h&&(u=100*(t.pageX-l.left)/p,d=100*(t.pageY-l.top)/r,u>100&&(u=100),d>100&&(d=100),u<0&&(u=0),d<0&&(d=0),n.css({left:+(l.left-n.width()/2+p*u*.01)+"px",top:+(l.top-n.height()/2+r*d*.01)+"px"})),h=!1}),m.on("click",function(){var t=this;$(document).off("mousemove"),$(document).off("mouseup"),$(document).off("mousedown"),s.attr("pos-x",u),s.attr("pos-y",d),e.fading=!1,$("#img-container-big").fadeOut("fast"),$(this).fadeOut("fast",function(){$("#img-container-big").remove(),t.remove(),o.fadeIn("fast")})})})}}),this.initDeleteButton(o),this.$images.push(i)},FileUploaderView.prototype.initDeleteButton=function(t){var e=this,i=0,o=null;t.click(function(s){s.preventDefault(),e.controller.isready()&&(o=$.data(t,"lpparent"),i=e.$images.indexOf(o),e.deleteImage(i))})},FileUploaderView.prototype.deleteImage=function(t){var e=this.$images[t],i=$(".imgup-add-input-container",this.$main_template);e.remove(),this.$images.splice(t,1),this.controller.deleteImage(t),this.updateurl(),this.controller.options.onready(),0===this.$images.length&&i.removeClass(this.controller.options.hidden_class)},FileUploaderView.prototype.loadTemplates=function(){this.main_template=FileUploaderTemplates["imgup-template"],this.img_template=FileUploaderTemplates["imgup-image-template"],this.add_img_template=FileUploaderTemplates["imgup-image-add-template"],""!==this.controller.options.templates.list_container_template&&(this.main_template=$(this.controller.options.templates.list_container_template).html()),""!==this.controller.options.templates.item_template&&(this.img_template=$(this.controller.options.templates.item_template).html()),""!==this.controller.options.templates.input_template&&(this.add_img_template=$(this.controller.options.templates.input_template).html())},FileUploaderView.prototype.clearImages=function(){this.controller.options.multi||($("li",this.$container).each(function(){$(this).hasClass("imgup-add-input-container")||$(this).remove()}),this.$images=[])},FileUploaderView.prototype.render=function(){var t=this.controller.options.multi,e=$(this.main_template),i=null;$("ul",e).append($(this.add_img_template)),this.$container.html(e),(i=$(".imgup-add-input",e)).attr("multiple",t),this.$main_template=e,this.addInputEvent(i)},FileUploaderView.prototype.updateUploadProgress=function(t,e){this.applyPercent(this.$images[t],e)},FileUploaderView.prototype.updateThumbProgress=function(t,e){this.applyPercent(this.$images[t],e)},FileUploaderView.prototype.imageDataLoaded=function(t){$(".imgup-progress-bar",this.$images[t]).css("opacity",1),$(".imgup-progress-bar",this.$images[t]).css("width",0)},FileUploaderView.prototype.showThumb=function(t,e){this.thumbs_loading.push({img:$("img",this.$images[t]),url:e,index:t}),this.loadingThumbgs()},FileUploaderView.prototype.loadingThumbgs=function(){if(!this.is_loading){var t=this;if(this.thumbs_loading.length>0){var e=this.thumbs_loading.shift();return setTimeout(function(){var i=e.img;i.loaded=!1,i.load(function(){i.loaded||($(".imgup-progress",t.$images[e.index]).css("display","none"),$(".imgup-image",t.$images[e.index]).addClass("show"),i.load=$.noop(),i.loaded=!0,i.css("opacity","1"),t.is_loading=!1,t.loadingThumbgs())}),i.css("opacity","0"),i.attr("src",t.controller.getBaseURL()+e.url)},100),void(t.is_loading=!0)}this.is_loading=!1}},FileUploaderView.prototype.applyPercent=function(t,e){$(".imgup-progress-bar",t).css("width",e+"%")},FileUploaderView.prototype.updateurl=function(){var t=this.controller.getImagesData();this.controller.getInput().val(t)},function(t,e,i,o){var s="fileuploader",a={isready:function(){var e=!0;return this.each(function(){t.data(this,"plugin_"+s).isready()||(e=!1)}),e},loadimages:function(e){this.each(function(){try{t.data(this,"plugin_"+s).preloadImages(e)}catch(t){}})}};t.fn[s]=function(e,i){var o={base_url:"",uploadurl:"/",response_type:"string",thumbnail:"",thumbnail_origin:"local",hidden_class:"imgup-hidden",multi:!0,sortable:!1,highlight_spot:!1,files_supported:".png|.jpg",onready:function(){},templates:{list_container_template:"",item_template:"",input_template:""},images:[]};try{o.support_pdf&&(o.files_supported+="|.pdf")}catch(t){}if(a[e])return a[e].call(this,i);i=e;var n=t.extend({},o,i);return this.each(function(){t.data(this,"plugin_"+s)||t.data(this,"plugin_"+s,new FileUploader(this,n))})}}(jQuery,window,document);var Waterfall=function(){this.images=[],this.upload_images=[],this.is_loading=!1,this.is_uploading=!1,this.uploading_counter=0,this.onready=$.noop};Waterfall.prototype.clearImages=function(){this.images=[]},Waterfall.prototype.appendImage=function(t){return t instanceof LPFile&&(!t.uploaded&&(this.images.push(t),this.loadThumbs(),!0))},Waterfall.prototype.loadThumbs=function(){if(!this.is_loading){var t=this;if(this.images.length>0){var e=this.images.shift();e.uploaded||(this.is_loading=!0,e.loadThumb(function(){t.is_loading=!1,t.loadThumbs(),t.upload_images.push(e),t.uploadImages()}))}else this.onready(),this.is_loading=!1}},Waterfall.prototype.uploadImages=function(){if(!(this.is_uploading&&this.uploading_counter>=3)){var t=this;if(this.upload_images.length>0){var e=this.upload_images.shift();return this.is_uploading=!0,this.uploading_counter+=1,void e.upload(function(){t.uploading_counter-=1,t.is_uploading=!1,t.uploadImages()})}this.uploading_counter-=1,this.is_uploading=!1}};